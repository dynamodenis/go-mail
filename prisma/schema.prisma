generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ───────────────────────────────────────────────────────────────────

enum ContactStatus {
  ACTIVE
  UNSUBSCRIBED
  BOUNCED
  CLEANED
}

enum CollectionType {
  MANUAL
  SMART
}

enum TemplateCategory {
  PROMOTIONAL
  NEWSLETTER
  ONBOARDING
  TRANSACTIONAL
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  PAUSED
  COMPLETED
  CANCELLED
}

enum SendStatus {
  QUEUED
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  FAILED
  UNSUBSCRIBED
}

enum SendingProvider {
  SES
  SENDGRID
  POSTMARK
  NONE
}

// ─── Models ──────────────────────────────────────────────────────────────────

model Contact {
  id        String        @id @default(uuid())
  userId    String
  email     String
  firstName String?
  lastName  String?
  status    ContactStatus @default(ACTIVE)
  metadata  Json          @default("{}")
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  collections   CollectionContact[]
  campaignSends CampaignSend[]

  @@unique([userId, email])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model Collection {
  id          String         @id @default(uuid())
  userId      String
  name        String
  description String         @default("")
  type        CollectionType @default(MANUAL)
  rules       Json?
  createdAt   DateTime       @default(now())

  contacts  CollectionContact[]
  campaigns CampaignCollection[]

  @@index([userId])
  @@index([createdAt])
}

model CollectionContact {
  collectionId String
  contactId    String

  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  contact    Contact    @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@id([collectionId, contactId])
  @@index([contactId])
  @@index([collectionId])
}

model Template {
  id           String           @id @default(uuid())
  userId       String
  name         String
  subject      String
  bodyHtml     String
  bodyJson     Json             @default("{}")
  category     TemplateCategory @default(PROMOTIONAL)
  thumbnailUrl String?
  timesUsed    Int              @default(0)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  campaigns   Campaign[]
  attachments TemplateAttachment[]
  mergeTags   TemplateMergeTag[]

  @@index([userId])
  @@index([category])
  @@index([createdAt])
}

model TemplateAttachment {
  id         String   @id @default(uuid())
  templateId String
  userId     String
  fileName   String
  fileUrl    String
  fileSize   Int
  mimeType   String
  createdAt  DateTime @default(now())

  template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([userId])
}

model TemplateMergeTag {
  id         String   @id @default(uuid())
  templateId String
  userId     String
  label      String
  value      String
  createdAt  DateTime @default(now())

  template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, value])
  @@index([templateId])
  @@index([userId])
}

model Campaign {
  id          String         @id @default(uuid())
  userId      String
  name        String
  templateId  String
  subject     String
  previewText String         @default("")
  status      CampaignStatus @default(DRAFT)
  scheduledAt DateTime?
  sentAt      DateTime?
  createdAt   DateTime       @default(now())

  template    Template             @relation(fields: [templateId], references: [id])
  collections CampaignCollection[]
  sends       CampaignSend[]
  links       CampaignLink[]

  @@index([userId])
  @@index([status])
  @@index([templateId])
  @@index([createdAt])
}

model CampaignCollection {
  campaignId   String
  collectionId String

  campaign   Campaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@id([campaignId, collectionId])
  @@index([collectionId])
  @@index([campaignId])
}

model CampaignSend {
  id             String     @id @default(uuid())
  campaignId     String
  contactId      String
  status         SendStatus @default(QUEUED)
  sentAt         DateTime?
  openedAt       DateTime?
  clickedAt      DateTime?
  bouncedAt      DateTime?
  unsubscribedAt DateTime?

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contact  Contact  @relation(fields: [contactId], references: [id])

  @@index([campaignId])
  @@index([contactId])
  @@index([status])
}

model CampaignLink {
  id         String @id @default(uuid())
  campaignId String
  url        String
  clickCount Int    @default(0)

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
}

model UserSettings {
  id              String          @id @default(uuid())
  userId          String          @unique
  fromName        String          @default("")
  replyTo         String          @default("")
  sendingProvider SendingProvider @default(NONE)
  apiKeyEncrypted String?
  dailyLimit      Int             @default(10000)
  nylasGrantId    String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([userId])
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String
  action     String
  entityType String
  entityId   String
  metadata   Json     @default("{}")
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}
